<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no, viewport-fit=cover" />
<meta name="theme-color" content="#111111" />
<meta name="mobile-web-app-capable" content="yes" />
<meta name="apple-mobile-web-app-capable" content="yes" />
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
<link rel="manifest" href="/manifest.webmanifest" />
<link rel="icon" type="image/svg+xml" href="/icons/icon.svg" />
<title>F3 30-Minute Beatdown</title>
<style>
  html,body{height:100%;overflow:hidden;-webkit-tap-highlight-color:transparent;-webkit-text-size-adjust:100%;text-size-adjust:100%;touch-action:manipulation;}
  body{font-family:Arial,Helvetica,sans-serif;background:#111;color:#f4f4f4;margin:0;padding:env(safe-area-inset-top) env(safe-area-inset-right) env(safe-area-inset-bottom) env(safe-area-inset-left);display:flex;flex-direction:column;align-items:center;justify-content:center;min-height:100dvh;}
  #card{background:#222;padding:1.25rem 1.5rem;border-radius:8px;box-shadow:0 0 10px #000;max-width:500px;width:90vw;}
  h1{font-size:1.35rem;margin:0 0 .5rem;}
  h2{font-size:1.05rem;margin:.75rem 0 .25rem;color:#00e0ff;}
  p{margin:.25rem 0 .5rem;line-height:1.4;}
  #timer{font-size:2.25rem;text-align:center;margin:.5rem 0;}
  button{padding:.6rem 1rem;margin:.25rem;border:none;border-radius:4px;font-size:1rem;cursor:pointer;min-height:44px;}
  #previous{background:#6c757d;color:#fff;}
  #start{background:#28a745;color:#fff;}
  #pause{background:#ffc107;color:#000;}
  #next{background:#007bff;color:#fff;}
  #add-workout{background:#17a2b8;color:#fff;}
  #controls{display:flex;justify-content:center;flex-wrap:wrap;}
  #segment-count{font-size:.85rem;text-align:center;color:#bbb;margin-top:.25rem;}
  a{color:#00e0ff;}
  #flow-diagram{display:flex;align-items:center;justify-content:center;margin-bottom:1rem;overflow-x:auto;padding:.5rem 0;}
  .chevron{display:flex;align-items:center;background:#333;border-radius:4px;margin:0 2px;min-width:80px;height:36px;position:relative;cursor:pointer;transition:all 0.2s ease;font-size:.8rem;text-align:center;justify-content:center;color:#ccc;}
  .chevron:hover{background:#444;color:#fff;}
  .chevron.active{background:#00e0ff;color:#000;font-weight:bold;}
  .chevron.completed{background:#28a745;color:#fff;}
  .chevron:not(:last-child):after{content:'';position:absolute;right:-8px;top:50%;transform:translateY(-50%);width:0;height:0;border-left:8px solid;border-top:8px solid transparent;border-bottom:8px solid transparent;z-index:2;}
  .chevron:not(:last-child):hover:after{border-left-color:#444;}
  .chevron.active:not(:last-child):after{border-left-color:#00e0ff;}
  .chevron.completed:not(:last-child):after{border-left-color:#28a745;}
  .chevron:not(:first-child){padding-left:12px;}
  @media (max-width: 600px){
    #card{width:94vw;padding:1rem 1.1rem;}
    h1{font-size:1.25rem;}
    #timer{font-size:2rem;}
    .chevron{min-width:56px;font-size:.7rem;}
  }
  
  /* Modal styles */
  .modal{display:none;position:fixed;z-index:1000;left:0;top:0;width:100%;height:100%;overflow:auto;background-color:rgba(0,0,0,0.8);}
  .modal-content{background-color:#333;margin:5% auto;padding:0;border-radius:8px;width:90%;max-width:600px;box-shadow:0 4px 20px rgba(0,0,0,0.5);}
  .modal-header{padding:1rem 1.5rem;border-bottom:1px solid #555;display:flex;justify-content:space-between;align-items:center;}
  .modal-header h2{margin:0;color:#f4f4f4;}
  .close{color:#bbb;font-size:28px;font-weight:bold;cursor:pointer;line-height:1;}
  .close:hover{color:#fff;}
  .modal-body{padding:1.5rem;}
  .modal-body p{color:#ccc;margin-bottom:1rem;}
  .json-example{background:#222;padding:1rem;border-radius:4px;color:#0f0;font-size:0.85rem;margin-bottom:1rem;overflow-x:auto;}
  #workout-json{width:100%;background:#222;color:#f4f4f4;border:1px solid #555;border-radius:4px;padding:0.75rem;font-family:monospace;font-size:0.9rem;resize:vertical;box-sizing:border-box;}
  #workout-json:focus{outline:none;border-color:#00e0ff;}
  .error-message{color:#ff4444;font-size:0.9rem;margin-top:0.5rem;display:none;}
  .modal-footer{padding:1rem 1.5rem;border-top:1px solid #555;display:flex;justify-content:flex-end;gap:0.5rem;}
  .modal-footer button{padding:0.5rem 1rem;border:none;border-radius:4px;cursor:pointer;font-size:0.9rem;}
  #cancel-workout{background:#6c757d;color:#fff;}
  #submit-workout{background:#28a745;color:#fff;}
</style>
</head>
<body>
  <div id="card">
    <h1>F3 30-Minute Beatdown</h1>
    <div id="flow-diagram"></div>
    <h2 id="segment-title"></h2>
    <p id="segment-desc"></p>
    <div id="timer">00:00</div>
    <div id="controls">
      <button id="previous">Previous</button>
      <button id="start">Start</button>
      <button id="pause">Pause</button>
      <button id="next">Next</button>
      <button id="add-workout">Add Workout</button>
    </div>
    <div id="segment-count"></div>
  </div>

  <!-- Modal for adding new workout -->
  <div id="workout-modal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h2>Add New Workout</h2>
        <span class="close">&times;</span>
      </div>
      <div class="modal-body">
        <p>Paste your workout JSON below. The format should be an array of segments with the following structure:</p>
        <pre class="json-example">
[
  {
    "title": "Warm-up (5 min)",
    "shortTitle": "Warm-up",
    "desc": "Exercise description",
    "dur": 300
  }
]</pre>
        <textarea id="workout-json" placeholder="Paste your workout JSON here..." rows="15"></textarea>
        <div id="json-error" class="error-message"></div>
      </div>
      <div class="modal-footer">
        <button id="cancel-workout">Cancel</button>
        <button id="submit-workout">Add Workout</button>
      </div>
    </div>
  </div>

<script>
// Register service worker for PWA installability and offline support
if ('serviceWorker' in navigator) {
  window.addEventListener('load', function(){
    navigator.serviceWorker.register('/sw.js').catch(function(err){
      console.warn('SW registration failed', err);
    });
  });
}
/* ------------ WORKOUT DATA ------------- */
const segments = [
  {
    title: "Warm-up (5 min)",
    shortTitle: "Warm-up",
    desc: "10 SSH • 10 Hillbilly Walkers • 10 Tappy Taps • 10 Slow Merkins • 10 Arm Circles FWD/BWD • Hill jog (1× up & down)",
    dur: 5*60
  },
  {
    title: "Round 1 – Hill Pump (8 min AMRAP)",
    shortTitle: "Round 1",
    desc: "10 Regular Merkins → Sprint up hill → 5 Burpees → Jog down → 20 Big Boy Sit-Ups → 10 Block Curls",
    dur: 8*60
  },
  {
    title: "Recovery (1 min)",
    shortTitle: "Recovery",
    desc: "Easy jog / walk • Hydrate",
    dur: 60
  },
  {
    title: "Round 2 – Coupon Burnout (8 min AMRAP)",
    shortTitle: "Round 2",
    desc: "10 Block Curl+Press • 20 Flutter Kicks (4-ct) • 5 Burpees • 10 Wide Merkins • 10 Block Rows",
    dur: 8*60
  },
  {
    title: "Recovery (1 min)",
    shortTitle: "Recovery",
    desc: "Easy jog / walk • Breathe",
    dur: 60
  },
  {
    title: "Round 3 – Sprint & Core Crush (8 min AMRAP)",
    shortTitle: "Round 3",
    desc: "Sprint up hill → 15 Gas Pumpers → 10 Incline Merkins → Jog down → 5 Burpees → 20 LBCs",
    dur: 8*60
  },
  {
    title: "Cooldown (2 min)",
    shortTitle: "Cooldown",
    desc: "Shoulder stretch • Deep squat hold • Hamstring stretch",
    dur: 2*60
  }
];
/* ------------ STATE ------------- */
let idx = 0;
let remaining = segments[0].dur;
let timerId = null;
const titleEl = document.getElementById("segment-title");
const descEl = document.getElementById("segment-desc");
const timerEl = document.getElementById("timer");
const segCountEl = document.getElementById("segment-count");
const flowEl = document.getElementById("flow-diagram");
const modal = document.getElementById("workout-modal");
const workoutJsonEl = document.getElementById("workout-json");
const jsonErrorEl = document.getElementById("json-error");
/* ------------ HELPERS ------------- */
function format(s){
  const m = String(Math.floor(s/60)).padStart(2,"0");
  const secs = String(s%60).padStart(2,"0");
  return `${m}:${secs}`;
}
function renderFlowDiagram(){
  flowEl.innerHTML = segments.map((segment, i) => {
    let className = "chevron";
    if(i < idx) className += " completed";
    if(i === idx) className += " active";
    return `<div class="${className}" data-index="${i}">${segment.shortTitle}</div>`;
  }).join('');
}
function render(){
  const seg = segments[idx];
  titleEl.textContent = seg.title;
  descEl.textContent = seg.desc;
  timerEl.textContent = format(remaining);
  segCountEl.textContent = `Segment ${idx+1} of ${segments.length}`;
  renderFlowDiagram();
}
function goToSegment(newIdx){
  if(newIdx >= 0 && newIdx < segments.length){
    clearInterval(timerId);
    timerId = null;
    idx = newIdx;
    remaining = segments[idx].dur;
    render();
  }
}
function nextSegment(){
  clearInterval(timerId);
  timerId = null;
  idx++;
  if(idx>=segments.length){
    titleEl.textContent="Workout Complete!";
    descEl.innerHTML = "Nice job! Hydrate and <a href='https://f3nation.com'>Post Again.</a>";
    timerEl.textContent="00:00";
    segCountEl.textContent="";
    return;
  }
  remaining = segments[idx].dur;
  render();
}
function previousSegment(){
  clearInterval(timerId);
  timerId = null;
  if(idx > 0){
    idx--;
    remaining = segments[idx].dur;
    render();
  }
}
function tick(){
  if(remaining>0){
    remaining--;
    timerEl.textContent = format(remaining);
  }else{
    nextSegment();
  }
}
function validateWorkoutData(data) {
  if (!Array.isArray(data)) {
    return "Workout data must be an array of segments.";
  }
  
  if (data.length === 0) {
    return "Workout must have at least one segment.";
  }
  
  for (let i = 0; i < data.length; i++) {
    const segment = data[i];
    
    if (typeof segment !== 'object' || segment === null) {
      return `Segment ${i + 1} must be an object.`;
    }
    
    if (typeof segment.title !== 'string' || segment.title.trim() === '') {
      return `Segment ${i + 1} must have a non-empty 'title' string.`;
    }
    
    if (typeof segment.shortTitle !== 'string' || segment.shortTitle.trim() === '') {
      return `Segment ${i + 1} must have a non-empty 'shortTitle' string.`;
    }
    
    if (typeof segment.desc !== 'string' || segment.desc.trim() === '') {
      return `Segment ${i + 1} must have a non-empty 'desc' string.`;
    }
    
    if (typeof segment.dur !== 'number' || segment.dur <= 0 || !Number.isInteger(segment.dur)) {
      return `Segment ${i + 1} must have a positive integer 'dur' (duration in seconds).`;
    }
  }
  
  return null; // No errors
}
function replaceWorkout(newSegments) {
  // Stop current timer
  clearInterval(timerId);
  timerId = null;
  
  // Replace global segments
  segments.length = 0;
  segments.push(...newSegments);
  
  // Reset to first segment
  idx = 0;
  remaining = segments[0].dur;
  
  // Re-render
  render();
}
function showModal() {
  modal.style.display = "block";
  workoutJsonEl.focus();
}
function hideModal() {
  modal.style.display = "none";
  workoutJsonEl.value = "";
  jsonErrorEl.style.display = "none";
  jsonErrorEl.textContent = "";
}
function showError(message) {
  jsonErrorEl.textContent = message;
  jsonErrorEl.style.display = "block";
}
/* ------------ BUTTON EVENTS ------------- */
document.getElementById("start").onclick = () => {
  if(!timerId){
    timerId = setInterval(tick,1000);
  }
};
document.getElementById("pause").onclick = () => {
  if(timerId){
    clearInterval(timerId);
    timerId = null;
  }else{
    timerId = setInterval(tick,1000);
  }
};
document.getElementById("previous").onclick = previousSegment;
document.getElementById("next").onclick = nextSegment;
document.getElementById("add-workout").onclick = showModal;
flowEl.addEventListener('click', (e) => {
  if(e.target.classList.contains('chevron')){
    const newIdx = parseInt(e.target.dataset.index);
    goToSegment(newIdx);
  }
});

// Modal event handlers
document.querySelector('.close').onclick = hideModal;
document.getElementById("cancel-workout").onclick = hideModal;

// Close modal when clicking outside of it
window.onclick = (event) => {
  if (event.target === modal) {
    hideModal();
  }
};

document.getElementById("submit-workout").onclick = () => {
  const jsonText = workoutJsonEl.value.trim();
  
  if (!jsonText) {
    showError("Please enter workout JSON data.");
    return;
  }
  
  let parsedData;
  try {
    parsedData = JSON.parse(jsonText);
  } catch (error) {
    showError("Invalid JSON format. Please check your syntax.");
    return;
  }
  
  const validationError = validateWorkoutData(parsedData);
  if (validationError) {
    showError(validationError);
    return;
  }
  
  // If we get here, the data is valid
  replaceWorkout(parsedData);
  hideModal();
};
/* ------------ INIT ------------- */
render();
</script>
</body>
</html>

